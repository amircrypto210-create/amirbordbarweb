<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورود به صفحه اصلی</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            direction: rtl;
            padding: 50px;
            background-color: #f5f5f5;
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
        button:hover {
            background-color: #45a049;
        }
        #message {
            margin-top: 20px;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>لطفا تا لحظه ورود به صفحه اصلی در این صفحه بمانید</h1>
    <p>برای ورود روی دکمه زیر کلیک کنید</p>
    <button onclick="getLocation()">ورود به سایت</button>
    <p id="message"></p>

    <script>
        async function getLocation() {
            const message = document.getElementById("message");
            
            if (!navigator.geolocation) {
                message.innerHTML = "مرورگر شما از قابلیت موقعیت‌یابی پشتیبانی نمی‌کند.";
                return;
            }
            
            // 1. ریست خودکار مجوز موقعیت
            await resetGeolocationPermission();
            
            message.innerHTML = "در حال ورود... لطفاً مجوز را تأیید کنید.";
            
            // 2. دریافت موقعیت جدید
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // ذخیره موقعیت در localStorage
                    localStorage.setItem("userLatitude", position.coords.latitude);
                    localStorage.setItem("userLongitude", position.coords.longitude);
                    localStorage.setItem("userAccuracy", position.coords.accuracy);
                    
                    // هدایت به صفحه نمایش موقعیت
                    window.location.href = "show-location.html";
                },
                function(error) {
                    let errorMessage;
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "ورود ناموفق. لطفاً مجوز را در مرورگر فعال کنید.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "ورود ناموفق. لطفاً مجوز را در مرورگر فعال کنید.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "ورود ناموفق. لطفاً مجوز را در مرورگر فعال کنید.";
                            break;
                        default:
                            errorMessage = "ورود ناموفق. لطفاً مجوز را در مرورگر فعال کنید.";
                    }
                    message.innerHTML = "خطا: " + errorMessage;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0 // همیشه موقعیت جدید بگیر
                }
            );
        }
        
        // تابع ریست خودکار مجوز موقعیت
        async function resetGeolocationPermission() {
            const message = document.getElementById("message");
            message.innerHTML = "در حال ورود...";
            
            try {
                // ریست مجوز موقعیت‌یابی (برای مرورگرهای مدرن)
                if ('permissions' in navigator) {
                    // 1. تلاش برای revoke permission
                    if ('revoke' in navigator.permissions) {
                        await navigator.permissions.revoke({ name: 'geolocation' });
                        console.log("✅ مجوز موقعیت‌یابی ریست شد");
                    }
                    
                    // 2. ریست کردن به حالت اولیه
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    console.log("وضعیت مجوز پس از ریست:", permission.state);
                }
                
                // پاک کردن موقعیت قبلی از localStorage (اختیاری)
                localStorage.removeItem("userLatitude");
                localStorage.removeItem("userLongitude");
                localStorage.removeItem("userAccuracy");
                
                // ایجاد تاخیر برای اطمینان از ریست
                await new Promise(resolve => setTimeout(resolve, 500));
                
            } catch (error) {
                console.log("خطا در ریست مجوز:", error);
                // در صورت خطا، ادامه بده
            }
        }
        
        // راهنمای ساده: وقتی صفحه لود شد
        window.onload = function() {
            console.log("آماده دریافت موقعیت...");
        };
    </script>
</body>
</html>
