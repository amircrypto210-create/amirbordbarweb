<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙ‚Ø¹ÛŒØª</title>
    
    <!-- Ù…ØªØ§ ØªÚ¯â€ŒÙ‡Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´ -->
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            direction: rtl;
            padding: 50px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
        }
        .location-info {
            background-color: white;
            border-radius: 20px;
            padding: 40px;
            margin: 30px auto;
            max-width: 600px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .map-link {
            display: inline-block;
            margin: 15px;
            padding: 15px 30px;
            background-color: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .map-link:hover {
            background-color: #0b7dda;
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.15);
        }
        .coordinates {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 25px 0;
            border-right: 5px solid #4CAF50;
            text-align: right;
            font-size: 18px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .back-button {
            background-color: #4CAF50;
        }
        .back-button:hover {
            background-color: #3d8b40;
        }
        .map-buttons {
            margin-top: 30px;
        }
        .location-icon {
            font-size: 60px;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-right: 5px solid #c62828;
        }
        .timestamp {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }
        .session-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border-right: 4px solid #ffc107;
            text-align: right;
            font-size: 14px;
        }
        .refresh-notice {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-right: 4px solid #28a745;
            text-align: right;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="location-info">
        <div class="session-warning">
            âš ï¸ ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆÙ‚ØªÛŒ Ù‡Ø³ØªÙ†Ø¯ Ùˆ Ø¨Ø§ Ø±ÙØ±Ø´ ØµÙØ­Ù‡ Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
        </div>
        
        <div id="refreshNotice" class="refresh-notice" style="display: none;">
            ğŸ”„ ØµÙØ­Ù‡ Ø±ÙØ±Ø´ Ø´Ø¯. Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯.
        </div>
        
        <div class="location-icon">ğŸ“</div>
        <h1>Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ</h1>
        
        <div id="locationData">
            <!-- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        
        <div class="map-buttons">
            <a href="index.html" class="map-link back-button">
                â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
            </a>
            <button onclick="forceCleanAndReturn()" class="map-link" style="background-color: #f44336; border: none; cursor: pointer;">
                ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª
            </button>
        </div>
    </div>

    <script>
        // ==================== ØªØ§Ø¨Ø¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ ====================
        function cleanAllStorage() {
            console.log('ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§...');
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ú†ÛŒØ²
            localStorage.clear();
            sessionStorage.clear();
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† IndexedDB
            if ('indexedDB' in window) {
                indexedDB.databases().then(databases => {
                    databases.forEach(db => {
                        if (db.name) indexedDB.deleteDatabase(db.name);
                    });
                }).catch(() => {});
            }
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Cache
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    cacheNames.forEach(cacheName => caches.delete(cacheName));
                }).catch(() => {});
            }
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Cookies Ù…Ø±ØªØ¨Ø·
            document.cookie.split(";").forEach(cookie => {
                const name = cookie.split("=")[0].trim();
                if (name.includes('geo') || name.includes('location')) {
                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                }
            });
            
            return true;
        }
        
        // ==================== ØªØ´Ø®ÛŒØµ Ø±ÙØ±Ø´ ====================
        function checkIfRefreshed() {
            const currentTime = Date.now();
            const lastAccess = sessionStorage.getItem('pageLastAccess');
            
            if (lastAccess) {
                const timeDiff = currentTime - parseInt(lastAccess);
                if (timeDiff < 1000) { // Ú©Ù…ØªØ± Ø§Ø² 1 Ø«Ø§Ù†ÛŒÙ‡
                    return true;
                }
            }
            
            sessionStorage.setItem('pageLastAccess', currentTime.toString());
            return false;
        }
        
        // ==================== Ø§Ø¬Ø±Ø§ÛŒ Ø§ØµÙ„ÛŒ ====================
        window.onload = function() {
            // Ø¨Ø±Ø±Ø³ÛŒ Ø±ÙØ±Ø´
            const wasRefreshed = checkIfRefreshed();
            
            if (wasRefreshed) {
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø±ÙØ±Ø´
                document.getElementById('refreshNotice').style.display = 'block';
                
                // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                cleanAllStorage();
                
                // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                
                return;
            }
            
            // Ø§Ø¯Ø§Ù…Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            displayLocationData();
        };
        
        // ==================== Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ====================
        function displayLocationData() {
            // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² sessionStorage
            const lat = sessionStorage.getItem("userLatitude");
            const lng = sessionStorage.getItem("userLongitude");
            const acc = sessionStorage.getItem("userAccuracy");
            const timestamp = sessionStorage.getItem("userTimestamp");
            
            const locationDataEl = document.getElementById("locationData");
            
            if(lat && lng) {
                locationDataEl.innerHTML = `
                    <h3>Ù…Ø®ØªØµØ§Øª Ø¯Ù‚ÛŒÙ‚:</h3>
                    <div class="coordinates">
                        <p><strong>Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ:</strong> ${parseFloat(lat).toFixed(6)}</p>
                        <p><strong>Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ:</strong> ${parseFloat(lng).toFixed(6)}</p>
                        <p><strong>Ø¯Ù‚Øª:</strong> ${acc ? Math.round(acc) : 'Ù†Ø§Ù…Ø´Ø®Øµ'} Ù…ØªØ±</p>
                    </div>
                    
                    <div class="map-buttons">
                        <a href="https://www.google.com/maps?q=${lat},${lng}" class="map-link" target="_blank">
                            ğŸ—ºï¸ Google Maps
                        </a>
                        <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=15/${lat}/${lng}" 
                           class="map-link" target="_blank" style="background-color: #7CB342;">
                            ğŸŒ OpenStreetMap
                        </a>
                    </div>
                    
                    ${timestamp ? `<div class="timestamp">ğŸ•’ Ø²Ù…Ø§Ù†: ${new Date(timestamp).toLocaleString('fa-IR')}</div>` : ''}
                `;
                
                addCopyButton(lat, lng);
            } else {
                locationDataEl.innerHTML = `
                    <div class="error-message">
                        <h3>âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                        <p>Ø¯Ù„Ø§ÛŒÙ„:</p>
                        <ul style="text-align: right; padding-right: 20px;">
                            <li>Ø´Ù…Ø§ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</li>
                            <li>ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</li>
                            <li>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯</li>
                        </ul>
                        <p>Ø¯Ø± Ø­Ø§Ù„ Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ...</p>
                    </div>
                `;
                
                document.querySelector('.location-icon').style.display = 'none';
                
                // Ù‡Ø¯Ø§ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 5 Ø«Ø§Ù†ÛŒÙ‡
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 5000);
            }
        }
        
        function addCopyButton(lat, lng) {
            const copyButton = document.createElement('button');
            copyButton.innerHTML = 'ğŸ“‹ Ú©Ù¾ÛŒ Ù…Ø®ØªØµØ§Øª';
            copyButton.style.cssText = `
                margin: 15px;
                padding: 10px 20px;
                background-color: #9C27B0;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s ease;
            `;
            copyButton.onmouseover = function() { this.style.backgroundColor = '#7B1FA2'; };
            copyButton.onmouseout = function() { this.style.backgroundColor = '#9C27B0'; };
            copyButton.onclick = function() {
                navigator.clipboard.writeText(`${lat}, ${lng}`).then(() => {
                    const originalText = copyButton.innerHTML;
                    copyButton.innerHTML = 'âœ… Ú©Ù¾ÛŒ Ø´Ø¯!';
                    copyButton.style.backgroundColor = '#4CAF50';
                    setTimeout(() => {
                        copyButton.innerHTML = originalText;
                        copyButton.style.backgroundColor = '#9C27B0';
                    }, 2000);
                });
            };
            
            document.querySelector('.map-buttons').prepend(copyButton);
        }
        
        function forceCleanAndReturn() {
            if(confirm("Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ú¯Ø±Ø¯ÛŒØ¯ØŸ")) {
                cleanAllStorage();
                window.location.href = 'index.html';
            }
        }
        
        // ==================== Event Listeners ====================
        window.addEventListener('beforeunload', function() {
            // Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø±ÙØ±Ø´
            sessionStorage.setItem('pageUnloading', 'true');
        });
        
        // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´ Ù…Ø±ÙˆØ±Ú¯Ø±
        if(window.history.replaceState) {
            const cleanURL = window.location.pathname;
            window.history.replaceState({}, document.title, cleanURL);
        }
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† timestamp Ø¨Ù‡ URL Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´
        if(!window.location.search.includes('nocache')) {
            const timestamp = new Date().getTime();
            window.location.search = `?nocache=${timestamp}`;
        }
    </script>
</body>
</html>
